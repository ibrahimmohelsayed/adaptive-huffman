<!DOCTYPE html>
<html lang="en">
<head>
    <title>Adaptive Huffman encoder</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="form-inline">
            <div class="form-group">
                <label class="control-label">Alphabet size</label>
                <input id="alphabet-size" value="26" class="form-control">
                <button id="init-button" class="btn">Create new tree</button>
            </div>
            <div class="form-group">
                <label class="control-label">Text</label>
                <input id="text" class="form-control">
            </div>
            <div class="form-group">
                <label class="control-label">Animation duration (ms)</label>
                <input id="anim-duration" value="800" class="form-control">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Output</label>
            <pre class="out"></pre>
            <label class="control-label">Approximate compression ratio</label>
            <pre class="compression"></pre>
        </div>
        <div class="form-group">
            <pre class="logs"></pre>
        </div>
    </div>
    <div class="row">
        <div id="svg-container"></div>
    </div>
</div>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="js/huffman.js" charset="utf-8"></script>
<script src="js/huffmanvis.js" charset="utf-8"></script>
<script type="text/javascript">
    var alphabetSize = 26,
            HuffmanInstance = new AdaptiveHuffman(alphabetSize),
            previousText = '',
            logContainer = document.querySelector('.logs'),
            outContainer = document.querySelector('.out'),
            compressContainer = document.querySelector('.compression'),
            animDurationEl = document.querySelector('#anim-duration');

    /**
     * Handles 'log' events.
     * @param {CustomEvent} e Event.
     */
    function logHandler(e) {
        'use strict';

        console.log('['.concat(e.detail.time.toLocaleString(), '] [LOG] ', e.detail.message));
        logContainer.innerHTML += e.detail.message.concat('\n');
    }

    /**
     * Handles 'encode' events.
     * @param {CustomEvent} e Event.
     */
    function encodeHandler(e) {
        'use strict';

        console.log('['.concat(e.detail.time.toLocaleString(), '] [ENCODER] ', e.detail.message));
        outContainer.innerHTML += e.detail.message;
        compressContainer.innerHTML = HuffmanInstance.getCompressionRatio();
    }

    /**
     * Handles 'Create new tree' button.
     */
    function buttonHandler() {
        'use strict';

        var size = parseInt(document.querySelector('#alphabet-size').value.trim(), 10);

        if (!isNaN(size)) {
            alphabetSize = size;
            logContainer.innerHTML = '';
            outContainer.innerHTML = '';
            compressContainer.innerHTML = '';
            document.querySelector('#text').value = '';
            HuffmanInstance = new AdaptiveHuffman(alphabetSize);
            initVis(); // from huffmanvis.js
        }
    }

    /**
     * Actions fired after change in input's field.
     */
    function textHandler() {
        'use strict';

        var text = document.querySelector('#text').value.trim(),
                diff;

        if ((previousText = '') || (text.indexOf(previousText) === 0)) {
            diff = text.substr(text.length - previousText.length - 1);
            if (diff.length === 1) {
                HuffmanInstance.encode(diff);
            } else {
                diff.split('').forEach(function (char) {
                    HuffmanInstance.encode(char);
                });
            }
            previousText = text;
        } else {
            buttonHandler();
        }
    }

    /**
     * Toggles opacity of an element.
     * @param {Event} e Triggering event.
     */
    function toggleOpacity(e) {
        e.target.style.opacity = Math.abs(e.target.style.opacity - 1);
    }

    // after everything is loaded
    window.onload = function () {
        'use strict';

        // bind listeners
        document.addEventListener('log', logHandler, false);
        document.addEventListener('encode', encodeHandler, false);
        document.querySelector('#init-button').onclick = buttonHandler;
        document.querySelector('#text').addEventListener('input', textHandler, false);
        logContainer.addEventListener('click', toggleOpacity, false);
        buttonHandler();
    };
</script>
</body>
</html>